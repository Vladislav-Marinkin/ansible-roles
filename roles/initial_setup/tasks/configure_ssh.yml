---
# ======================================
# üìÇ 1Ô∏è‚É£ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
# ======================================
- name: Include User variables
  include_vars: vars/users.yml

- name: Include SSH variables
  include_vars: vars/ssh.yml

# ======================================
# üîß 2Ô∏è‚É£ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ SSH
# ======================================
- name: Ensure sshd_config.d directory exists
  file:
    path: /etc/ssh/sshd_config.d
    state: directory
    mode: '0644'

- name: Remove all files from sshd_config.d
  shell: rm -rf /etc/ssh/sshd_config.d/*

- name: Deploy SSH configuration from template
  template:
    src: ssh_config.j2
    dest: /etc/ssh/sshd_config.d/coustom_ssh.conf
    mode: '0644'
  notify: Restart SSH Service

# ===============================================
# üîë 3Ô∏è‚É£ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è SSH-–∫–ª—é—á–µ–π –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ
# ===============================================
- name: Ensure /tmp/ssh directory exists
  file:
    path: /tmp/ssh
    state: directory
    mode: '0755'
  delegate_to: localhost
  become: no

- name: Generate SSH key pair on local machine
  openssh_keypair:
    path: "/tmp/ssh/id_ansible"
    type: rsa
    size: 4096
    force: no
  delegate_to: localhost
  run_once: true
  become: no

- name: Copy SSH private key to localhost
  copy:
    src: "/tmp/ssh/id_ansible"
    dest: "~/.ssh/id_rsa"
    mode: "0600"
  delegate_to: localhost
  become: no

- name: Copy SSH public key to localhost
  copy:
    src: "/tmp/ssh/id_ansible.pub"
    dest: "~/.ssh/id_rsa.pub"
    mode: "0600"
  delegate_to: localhost
  become: no

# ===========================================================
# üîç 4Ô∏è‚É£ –ß—Ç–µ–Ω–∏–µ –∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ SSH-–∫–ª—é—á–µ–π –Ω–∞ —É–¥–∞–ª—ë–Ω–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä–∞
# ===========================================================

# üîπ –ß–∏—Ç–∞–µ–º –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á
- name: Read public SSH key
  set_fact:
    ssh_public_key: "{{ lookup('file', '/tmp/ssh/id_ansible.pub') }}"
  delegate_to: localhost
  run_once: true
  become: no

# üîπ –ß–∏—Ç–∞–µ–º –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á
- name: Read private SSH key
  set_fact:
    ssh_private_key: "{{ lookup('file', '/tmp/ssh/id_ansible') | regex_replace('$', '\n') }}"
  delegate_to: localhost
  run_once: true
  become: no

# üîπ –ö–æ–ø–∏—Ä—É–µ–º –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –Ω–∞ —É–¥–∞–ª—ë–Ω–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä—ã (–¥–æ–±–∞–≤–ª—è–µ–º –≤ authorized_keys)
- name: Copy SSH public key to remote servers
  authorized_key:
    user: "{{ item.name }}"
    state: present
    key: "{{ ssh_public_key }}"
  with_items: "{{ users }}"
  when: item.create_ssh_key | default(true)

# üîπ –ö–æ–ø–∏—Ä—É–µ–º –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á –Ω–∞ —É–¥–∞–ª—ë–Ω–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä—ã (–≤ ~/.ssh/id_rsa)
- name: Copy SSH private key file to remote servers
  copy:
    content: "{{ ssh_private_key }}"
    dest: "/home/{{ item.name }}/.ssh/id_rsa"
    mode: "0600"
    owner: "{{ item.name }}"
    group: "{{ item.name }}"
  with_items: "{{ users }}"
  when: item.create_ssh_key | default(true)
