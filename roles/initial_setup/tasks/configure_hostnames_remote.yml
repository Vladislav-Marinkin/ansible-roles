---
# ======================================
# üîç 1Ô∏è‚É£ –°–±–æ—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ —Å —É–¥–∞–ª—ë–Ω–Ω—ã—Ö —Ö–æ—Å—Ç–æ–≤ (–∫—Ä–æ–º–µ new_servers)
# ======================================
- name: Collect remote host details
  ansible.builtin.setup:
  delegate_to: "{{ item }}"  # –í—ã–ø–æ–ª–Ω—è–µ–º –∫–æ–º–∞–Ω–¥—É –Ω–∞ —É–¥–∞–ª—ë–Ω–Ω—ã—Ö —Ö–æ—Å—Ç–∞—Ö
  delegate_facts: true  # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–±—Ä–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ hostvars
  loop: "{{ groups['all'] | difference(groups['new_servers']) }}"  # –ò—Å–∫–ª—é—á–∞–µ–º new_servers
  run_once: true  # –í—ã–ø–æ–ª–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑ (–¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞—Ç—Ä–∞–≥–∏–≤–∞–µ—Ç –≤—Å–µ —Ö–æ—Å—Ç—ã)

# ======================================
# üìù 2Ô∏è‚É£ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ /etc/hosts (–∫—Ä–æ–º–µ new_servers)
# ======================================
- name: Ensure correct IP and hostname in /etc/hosts for all hosts except new_servers
  ansible.builtin.lineinfile:
    path: /etc/hosts
    regexp: "^.*\\s+{{ hostvars[item]['ansible_hostname'] }}$"  # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∑–∞–ø–∏—Å—å —Å —Ç–∞–∫–∏–º hostname
    line: "{{ hostvars[item]['ansible_default_ipv4']['address'] | default('127.0.0.1') }} {{ hostvars[item]['ansible_hostname'] }}"  # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º IP –∏ hostname
    state: present
    backup: yes  # –°–æ–∑–¥–∞—ë–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é /etc/hosts –ø–µ—Ä–µ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º
  loop: "{{ groups['all'] | difference(groups['new_servers']) }}"  # –ò—Å–∫–ª—é—á–∞–µ–º new_servers
  when: hostvars[item]['ansible_default_ipv4'] is defined  # –í—ã–ø–æ–ª–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å IP
