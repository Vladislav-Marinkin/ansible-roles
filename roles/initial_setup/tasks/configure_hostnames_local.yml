---
# ======================================
# üñ•Ô∏è 1Ô∏è‚É£ –ò–∑–º–µ–Ω–µ–Ω–∏–µ hostname –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–º —Ö–æ—Å—Ç–µ
# ======================================
- name: Change hostname
  ansible.builtin.hostname:
    name: "{{ hostvars[inventory_hostname]['hostname'] }}"

# ======================================
# üîç 2Ô∏è‚É£ –°–±–æ—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –Ω–æ–≤—ã—Ö —Å–µ—Ä–≤–µ—Ä–∞—Ö
# ======================================
- name: Collect remote host details
  ansible.builtin.setup:
  delegate_to: "{{ item }}"  # –í—ã–ø–æ–ª–Ω—è–µ–º –∫–æ–º–∞–Ω–¥—É –Ω–∞ —É–¥–∞–ª—ë–Ω–Ω—ã—Ö —Ö–æ—Å—Ç–∞—Ö
  delegate_facts: true  # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–±—Ä–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ hostvars
  loop: "{{ groups['new_servers'] }}"  # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Ö–æ—Å—Ç—ã –∏–∑ –≥—Ä—É–ø–ø—ã "new_servers"

# ======================================
# üìù 3Ô∏è‚É£ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ /etc/hosts –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–º —Ö–æ—Å—Ç–µ
# ======================================
- name: Ensure correct IP and hostname in /etc/hosts to local host
  ansible.builtin.lineinfile:
    path: /etc/hosts
    regexp: "^.*\\s+{{ hostvars[item]['hostname'] }}$"  # –ü–æ–∏—Å–∫ —Å—Ç—Ä–æ–∫–∏ —Å hostname
    line: "{{ hostvars[item]['ansible_default_ipv4']['address'] }} {{ hostvars[item]['hostname'] }}"  # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º IP –∏ hostname
    state: present
    backup: yes  # –°–æ–∑–¥–∞—ë–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é /etc/hosts –ø–µ—Ä–µ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º
  delegate_to: localhost  # –í—ã–ø–æ–ª–Ω—è–µ–º –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–º —Ö–æ—Å—Ç–µ
  loop: "{{ groups['new_servers'] }}"  # –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º –Ω–æ–≤—ã–µ —Å–µ—Ä–≤–µ—Ä–∞
