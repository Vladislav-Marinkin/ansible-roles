---
# =================================================
# üîó 1Ô∏è‚É£ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è Docker
# =================================================

- name: Include Docker repository setup tasks
  include_tasks: docker_repo.yml

# ======================================
# üê≥ 2Ô∏è‚É£ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker
# ======================================

# üöÄ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Docker (RedHat)
- name: Install Docker for RedHat family
  yum:
    name: docker-ce
    state: present
  when: ansible_os_family == "RedHat"

# üöÄ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Docker (Debian)
- name: Install Docker for Debian family
  apt:
    name: docker-ce
    state: present
    update_cache: yes
  when: ansible_os_family == "Debian"

# ======================================
# ‚öôÔ∏è 3Ô∏è‚É£ –ó–∞–ø—É—Å–∫ –∏ –≤–∫–ª—é—á–µ–Ω–∏–µ Docker
# ======================================

# üîÑ –í–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫ Docker –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –µ–≥–æ
- name: Enable and start Docker service
  systemd:
    name: docker
    state: started
    enabled: yes

# ======================================
# üîß 4Ô∏è‚É£ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Swarm 
# ======================================

# üõ†Ô∏è –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Docker Swarm –Ω–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–µ
- name: Initialize Docker Swarm on manager node
  include_tasks: init_docker_swarm.yml
  when: hostvars[inventory_hostname].get('master', false)

# üñß –ü–æ–¥–∫–ª—é—á–∞–µ–º –≤–æ—Ä–∫–µ—Ä –Ω–æ–¥—ã –∫ Docker Swarm
- name: Join workers to Swarm
  shell: docker swarm join --token {{ swarm_worker_token }} {{ swarm_manager_host }}:2377
  when: not hostvars[inventory_hostname].get('master', false)
  ignore_errors: yes

# ===============================================
# üë§ 5Ô∏è‚É£ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –≥—Ä—É–ø–ø—É Docker
# ===============================================

# üë• –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –≥—Ä—É–ø–ø—É Docker, —á—Ç–æ–±—ã –∑–∞–ø—É—Å–∫–∞—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –±–µ–∑ sudo
- name: Add users to docker group
  user:
    name: "{{ item }}"
    groups: docker
    append: yes
  with_items: "{{ docker_settings.users }}"

# ======================================
# üõ†Ô∏è 6Ô∏è‚É£ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker Compose
# ======================================

- name: Install docker-compose
  include_tasks: install_docker_compose.yml
  when: install_docker_compose