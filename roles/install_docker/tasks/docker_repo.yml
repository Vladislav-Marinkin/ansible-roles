---
# ======================================
# üèóÔ∏è 1Ô∏è‚É£ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
# ======================================

# üîß –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–∞–∫–µ—Ç—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è–º–∏ –∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º–∏ (RedHat)
- name: Install required dependencies for RedHat family
  yum:
    name:
      - yum-utils
      - device-mapper-persistent-data
      - lvm2
    state: present
  when: ansible_os_family == "RedHat"

# üîß –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–∞–∫–µ—Ç—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è–º–∏ –∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º–∏ (Debian)
- name: Install required dependencies for Debian family
  apt:
    name:
      - apt-transport-https
      - ca-certificates
      - curl
      - gnupg
      - software-properties-common
    state: present
    update_cache: yes
  when: ansible_os_family == "Debian"

  # =================================================
# üîë 2Ô∏è‚É£ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è Docker
# =================================================

# üê≥ –î–æ–±–∞–≤–ª—è–µ–º Docker-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –¥–ª—è RedHat/Oracle Linux
- name: Add Docker repository for RedHat family
  shell: |
    dnf config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
  args:
    creates: /etc/yum.repos.d/docker-ce.repo
  when: ansible_os_family == "RedHat"

# üìÇ –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è GPG-–∫–ª—é—á–µ–π (–µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
- name: Ensure /etc/apt/keyrings exists
  file:
    path: /etc/apt/keyrings
    state: directory
    mode: '0755'
  when: ansible_os_family == "Debian"

# üîë –°–∫–∞—á–∏–≤–∞–µ–º GPG-–∫–ª—é—á Docker (–¥–ª—è Debian/Ubuntu)
- name: Download Docker GPG key
  get_url:
    url: "https://download.docker.com/linux/{{ ansible_distribution | lower }}/gpg"
    dest: "/etc/apt/keyrings/docker.asc"
    mode: '0644'
  when: ansible_os_family == "Debian"

# üîì –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ –¥–ª—è GPG-–∫–ª—é—á–∞ Docker
- name: Set permissions for Docker GPG key
  file:
    path: "/etc/apt/keyrings/docker.asc"
    mode: '0644'
  when: ansible_os_family == "Debian"

# üîÑ –ü–æ–ª—É—á–∞–µ–º –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É —Å–∏—Å—Ç–µ–º—ã (–¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è)
- name: Get system architecture
  command: dpkg --print-architecture
  register: system_architecture
  changed_when: false
  when: ansible_os_family == "Debian"

# üîÑ –ü–æ–ª—É—á–∞–µ–º `VERSION_CODENAME` (–Ω–∞–ø—Ä–∏–º–µ—Ä, focal, jammy) –∏–∑ `/etc/os-release`
- name: Get OS version codename
  command: bash -c '. /etc/os-release && echo "$VERSION_CODENAME"'
  register: os_codename
  changed_when: false
  when: ansible_os_family == "Debian"

# üê≥ –î–æ–±–∞–≤–ª—è–µ–º Docker-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –≤ APT-–∏—Å—Ç–æ—á–Ω–∏–∫–∏
- name: Add Docker repository
  copy:
    dest: "/etc/apt/sources.list.d/docker.list"
    content: |
      deb [arch={{ system_architecture.stdout }} signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/{{ ansible_distribution | lower }} {{ os_codename.stdout }} stable
    mode: '0644'
  when: ansible_os_family == "Debian"

# üîÑ –û–±–Ω–æ–≤–ª—è–µ–º APT-–∫—ç—à –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
- name: Update apt cache
  apt:
    update_cache: yes
  when: ansible_os_family == "Debian"

