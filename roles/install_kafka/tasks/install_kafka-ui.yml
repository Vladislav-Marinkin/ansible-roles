---
# ====================================================
# üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –ø–æ—Ä—Ç–∞
# ====================================================
- name: Check for available port
  shell: |
    for port in $(seq 40000 50000); do
      if ! ss -tuln | grep -q ":$port "; then
        echo $port
        break
      fi
    done
  register: free_port
  changed_when: false

# ====================================================
# üßë‚Äçüíª –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–Ω–∞—á–µ–Ω–∏—è —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –ø–æ—Ä—Ç–∞
# ====================================================
- name: Set free port fact
  set_fact:
    free_port_value: "{{ free_port.stdout | trim }}"

# ====================================================
# üóÇÔ∏è –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è Kafka UI
# ====================================================
- name: Create dir for Kafka UI
  file:
    path: kafka-ui
    state: directory

# ====================================================
# üìù –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ docker-compose.yml
# ====================================================
- name: Create docker-compose.yml
  template:
    src: docker-compose.yml.j2
    dest: "kafka-ui/docker-compose.yml"
    mode: "0644"

# ====================================================
# üöÄ –ó–∞–ø—É—Å–∫ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
# ====================================================
- name: Run Docker container
  shell: |
    cd kafka-ui && docker-compose up -d

# ====================================================
# üìù –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¥–ª—è nginx
# ====================================================
- name: Create config for nginx
  template:
    src: kafka-ui.conf.j2
    dest: /etc/nginx/conf.d/kafka-ui.conf
    mode: '0644'
  notify: Reload nginx