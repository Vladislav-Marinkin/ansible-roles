---
# ===============================================
# üõ†Ô∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Kafka –∏ —Å–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤
# ===============================================

- name: Set up Kafka configuration file
  template:
    src: kafka-server.properties.j2
    dest: "{{ kafka_config_dir }}/kraft/server.properties"
    owner: "{{ kafka_user }}"
    group: "{{ kafka_group }}"
    mode: "0644"

- name: Create Kafka systemd service
  template:
    src: kafka.service.j2
    dest: "/etc/systemd/system/kafka.service"
    owner: root
    group: root
    mode: "0644"

# ====================================================
# üîë –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ UUID –¥–ª—è –∫–ª–∞—Å—Ç–µ—Ä–∞ Kafka
# ====================================================

- name: Run generate random UUID
  command: /opt/kafka/bin/kafka-storage.sh random-uuid
  register: kafka_uuid_output
  run_once: true

# ==========================================================
# üìÇ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ª–æ–≥–æ–≤ –¥–ª—è KRaft (Kafka Raft) —Å UUID
# ==========================================================
- name: Init kraft logs dir
  become_user: "{{ kafka_user }}"
  shell: "{{ kafka_install_dir }}/bin/kafka-storage.sh format --config {{ kafka_config_dir }}/kraft/server.properties --cluster-id {{ kafka_uuid_output.stdout }}"
