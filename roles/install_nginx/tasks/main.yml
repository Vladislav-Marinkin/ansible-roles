---
# ====================================================
# üõ†Ô∏è –°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã –¥–ª—è nginx
# ====================================================
- name: Create nginx group
  group:
    name: "{{ nginx_group }}"
    state: present

# ====================================================
# üßë‚Äçüíª –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è nginx
# ====================================================
- name: Create nginx user
  user:
    name: "{{ nginx_user }}"
    group: "{{ nginx_group }}"
    state: present

# ====================================================
# üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Nginx
# ====================================================
- name: Install nginx
  package:
    name: nginx
    state: present
  notify: Start service

# ====================================================
# üîô –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ nginx
# ====================================================
- name: Backup nginx.conf
  copy:
    src: /etc/nginx/nginx.conf
    dest: /etc/nginx/nginx.conf.backup
    mode: '0644'
    remote_src: yes

# ====================================================
# üìù –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ nginx –∏–∑ —à–∞–±–ª–æ–Ω–∞
# ====================================================
- name: Creating nginx configuration
  template:
    src: nginx.conf.j2
    dest: /etc/nginx/nginx.conf
  notify: Reload nginx

# ====================================================
# üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ SELinux
# ====================================================
- name: Check if SELinux is enabled
  command: getenforce
  register: selinux_status
  changed_when: false
  ignore_errors: true

# ====================================================
# üõ°Ô∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SELinux, –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω
# ====================================================
- block:

  #üîπ–û—Ç–∫—Ä—ã–≤–∞–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω –ø–æ—Ä—Ç–æ–≤ –¥–ª—è Nginx
  - name: Allow required ports in SELinux
    community.general.seport:
      ports: "40000-50000"
      proto: tcp
      setype: ntop_port_t
      state: present

  #üîπ–ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª –ø–æ–ª–∏—Ç–∏–∫–∏ SELinux –¥–ª—è Nginx
  - name: "SELinux - allow nginx write to socket - copy type enforcement file"
    template:
      src: nginx.te
      dest: /root/nginx.te
      mode: 0644

  #üîπ–ö–æ–º–ø–∏–ª—è—Ü–∏—è –ø–æ–ª–∏—Ç–∏–∫–∏ –≤ –º–æ–¥—É–ª—å
  - name: Compile the SELinux policy
    command: checkmodule -M -m -o /root/nginx.mod /root/nginx.te
    args:
      creates: /root/nginx.mod

  #üîπ–°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–∫–µ—Ç–∞ –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è SELinux
  - name: Create the SELinux policy package
    command: semodule_package -o /root/nginx.pp -m /root/nginx.mod
    args:
      creates: /root/nginx.pp

  #üîπ–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–∞–∫–µ—Ç –ø–æ–ª–∏—Ç–∏–∫–∏ SELinux –¥–ª—è Nginx
  - name: Install the SELinux policy
    command: semodule -i /root/nginx.pp

  when: selinux_status.stdout == 'Enforcing'
